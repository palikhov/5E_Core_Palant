define(["require","exports","tslib","react","lodash","classnames","typescript/libraries/comments2/src/components/thread/index","typescript/libraries/comments2/src/components/comment_stream/comment_stream_post_bar","typescript/libraries/comments2/src/components/comment/index","typescript/libraries/comments2/src/components/comment_editor/comment_utils","typescript/libraries/comments2/src/components/comment_editor/comment_editor","typescript/libraries/comments2/src/components/types/index","prop-types","typescript/libraries/comments2/src/components/comment_stream/unread_pill_wrapper","typescript/libraries/comments2/src/components/utils/calc_visibility_data","typescript/libraries/comments2/src/components/utils/visibility_aware_scroll_list","typescript/libraries/comments2/src/components/comment_editor/draft_utils","spectrum/tooltip/index","spectrum/icon_global/index","typescript/libraries/comments2/src/components/coachmark_location/index","typescript/libraries/comments2/src/components/comment_stream/cloud_doc_message","typescript/libraries/comments2/src/components/comment_stream/first_party_comment_advisory","typescript/libraries/comments2/src/components/types/index","react-intl","dig-components/typography"],(function(e,t,o,n,r,a,i,s,c,d,l,m,p,u,h,f,v,C,E,y,b,g,k,A,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommentStream=void 0,n=o.__importStar(n),a=o.__importDefault(a),d=o.__importStar(d),p=o.__importDefault(p);var _=function(){},T=A.defineMessage({id:"XI84a1",defaultMessage:"Comments on this file will show up here."}),M=(function(e){function t(t){var r=e.call(this,t)||this;return r.threadIdToRef={},r.editorHasChanges={},r.onThreadInteractedWith=function(e){var t=r.props,o=t.activeThreadID,n=t.collapsed,a=t.actionsAdapter,i=a.onThreadActivated,s=a.onInteractionWhileCollapsed;n&&s&&s(m.CollapsedInteraction.AVATAR_CLICK),o!==e.id&&i(e)},r.onVisibilityDataChange=function(e){r.setState({visibilityData:e})},r.updateTrackedItems=function(){var e,t;r.setState({trackedItems:(e=r.props.threads,t=r.threadIdToRef,e.map((function(e){return{item:e,ref:t[e.id]}})).filter((function(e){var t=e.item,o=e.ref;return!t.read&&o})))})},r.createUpdateCoachmarkPosition=function(e){return function(t){r.setState((function(n){var a;return y.areCoachmarkPositionsEqual(r.state.coachmarkPositions[e],t)?null:{coachmarkPositions:o.__assign(o.__assign({},n.coachmarkPositions),(a={},a[e]=t,a))}}))}},r.coachmarkPropsCache={},r.onStartEdit=function(e){r.setState({editedComment:e})},r.onEndEdit=function(){r.setState({editedComment:void 0})},r.onLeaveACommentClick=function(){var e=r.props,t=e.collapsed,o=e.actionsAdapter.onInteractionWhileCollapsed;t&&(o&&o(m.CollapsedInteraction.LEAVE_COMMENT_CLICK),r.focusPrimaryEditor())},r.setDraftRef=function(e){r.draftRef=e},r.setThreadRef=function(e,t){r.threadIdToRef[e]=t&&t.innerRef},r.handleClick=function(e){e.target.classList.contains("sc-comment-stream-threads")&&(r.props.actionsAdapter.onAllThreadsDeactivated(),r.editorHasChanges.PRIMARY||r.props.actionsAdapter.onCommentDraftCancel())},r.onThreadReplyCancel=function(){r.props.actionsAdapter.onAllThreadsDeactivated()},r.onPrimaryEditorCancel=function(){document.activeElement&&r.blurElement(document.activeElement),r.props.actionsAdapter.onCommentDraftCancel(),r.setState({content:d.createEmptyContent(),editedComment:void 0})},r.onPrimaryEditorFocus=function(){r.props.actionsAdapter.onAllThreadsDeactivated(),r.props.actionsAdapter.onEditorFocused()},r.onEditorStateChange=function(e){return function(t){r.editorHasChanges[e]=!v.contentIsEmpty(t)}},r.onPrimaryEditorStateChange=function(e){r.onEditorStateChange("PRIMARY")(e),r.props.actionsAdapter.onEditorStateChange(e)},r.hasUnsavedChanges=function(){var e=r.props.threads;return r.editorHasChanges.PRIMARY||e.some((function(e){return r.editorHasChanges[e.id]||!!e.pending}))||void 0!==r.state.editedComment},r.promptBeforeCloseHandler=function(e){if(r.hasUnsavedChanges())return e.returnValue="",e.preventDefault(),""},r.createThreadActions=function(e){var t=r.props.actionsAdapter,o=t.onCommentDeleted,n=t.onCommentEdited,a=t.onClickAnnotation,i=t.onEditorFocused,s=t.onMentionsQueryUpdated,c=t.onThreadMarkedAsRead,d=t.onThreadMarkedAsUnread,l=t.onThreadRepliedTo,m=t.onThreadResolved,p=t.onThreadUnresolved,u=t.onThreadMouseEnter,h=void 0===u?_:u,f=t.onThreadMouseLeave,v=void 0===f?_:f,C=t.onThreadFocus,E=void 0===C?_:C,y=t.onThreadBlur,b=void 0===y?_:y,g=t.onClickOlderInfo,k=void 0===g?_:g,A=t.onApproverRespond,P=t.onEditApproval,T=t.onDeleteApprovalComment,M=t.onResubmitApprovalFocus,R=t.onResubmitApprovalBlur,D=t.onResubmitApprovalRequest,S=t.onRemoveApprovalThread;return{onClickAnnotation:a,onReply:function(t){return l(e,t)},onMarkAsRead:function(){return c(e)},onMarkAsUnread:function(){return d(e)},onResolve:function(){return m(e)},onUnresolve:function(){return p(e)},onMouseEnter:function(){return h(e)},onMouseLeave:function(){return v(e)},onFocus:function(){return E(e)},onBlur:function(){return b(e)},onEditorFocused:function(){return i(e)},onCommentDeleted:function(t){return o(t,e)},onCommentEdited:function(t,o){return n(t,o,e)},onMentionsQueryUpdated:s,onClickOlderInfo:k,onEditorStateChange:r.onEditorStateChange(e),onApproverRespond:function(){return A(e)},onEditApproval:function(t){return P(e,t)},onDeleteApprovalComment:function(t,o){return T(t,e,o)},onResubmitApprovalFocus:function(){return M(e)},onResubmitApprovalBlur:R,onResubmitApprovalRequest:function(t){return D(e,t)},onRemoveApprovalThread:function(){return S(e)}}},r.renderPostBar=n.memo((function(e){return n.createElement(s.CommentStreamPostBar,Object.assign({coachmarkTargetProps:r.createCoachmarkProps("target")},e))})),r.state={content:d.createEmptyContent(),editedComment:void 0,visibilityData:h.createEmptyVisibilityData(),trackedItems:[],coachmarkPositions:{location:null,target:null},context:{useV2Design:t.useDesignV2,showApproval:t.showApproval}},r}return o.__extends(t,e),t.prototype.getChildContext=function(){return{localization:this.props.localization,useV2Design:!!this.props.useDesignV2,showApproval:!!this.props.showApproval}},t.prototype.createCoachmarkProps=function(e){if(e in this.coachmarkPropsCache)return this.coachmarkPropsCache[e];var t=this.props.coachmarkData||{component:function(){return null}},n=o.__assign(o.__assign({},t),{updatePosition:this.createUpdateCoachmarkPosition(e),positions:this.state.coachmarkPositions});return this.coachmarkPropsCache[e]=n,n},t.prototype.clearCachedCoachmarkProps=function(){this.coachmarkPropsCache={}},t.prototype.componentDidMount=function(){window.addEventListener("beforeunload",this.promptBeforeCloseHandler),this.updateTrackedItems()},t.prototype.componentDidUpdate=function(e){var t=e.threads;this.props.threads!==t&&this.updateTrackedItems()},Object.defineProperty(t.prototype,"sortedThreads",{get:function(){var e=r.partition(this.props.threads,"isThirdParty"),t=e[0],n=e[1];return o.__spreadArrays(t,n)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sortedVisibleThreads",{get:function(){return!this.includeEditorMeatball&&!this.props.useDesignV2||this.props.showResolvedComments?this.sortedThreads:this.sortedThreads.filter((function(e){return!(e.resolved||e.resolvedInfo)}))},enumerable:!1,configurable:!0}),t.prototype.componentWillUnmount=function(){window.removeEventListener("beforeunload",this.promptBeforeCloseHandler)},t.prototype.UNSAFE_componentWillReceiveProps=function(e){e.coachmarkData!==this.props.coachmarkData&&(this.clearCachedCoachmarkProps(),this.setState({coachmarkPositions:{location:null,target:null}}))},t.prototype.focusPrimaryEditor=function(){this.draftRef&&this.draftRef.focusEditor()},t.prototype.blurElement=function(e){var t;"function"==typeof Event?t=new FocusEvent("blur"):(t=document.createEvent("Event")).initEvent("blur",!0,!0),e.dispatchEvent(t)},Object.defineProperty(t.prototype,"includeEditor",{get:function(){var e=this.props,t=e.isMobile;return e.settings.canShowEditor&&!t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"includeEditorMeatball",{get:function(){var e=this.props.settings;return this.includeEditor&&e.canShowEditorMeatball},enumerable:!1,configurable:!0}),t.prototype.render=function(){var e=this,t=this.props,o=t.actionsAdapter,r=o.onMentionsQueryUpdated,s=o.onThreadCreated,d=t.className,m=void 0===d?"":d,p=t.commentComponent,h=void 0===p?function(e){return n.createElement(c.Comment,Object.assign({},e))}:p,v=t.editorComponent,_=void 0===v?function(e){return n.createElement(l.CommentEditor,Object.assign({},e))}:v,M=t.enabled,R=t.user,D=t.mentionsMatches,S=t.activeThreadID,I=t.hoverThreadID,w=t.focusedThreadID,F=t.isGoogleDSS,O=t.isMobile,U=t.localization.intl,V=t.collapsed,L=void 0!==V&&V,x=t.coachmarkData,W=t.placeholderOverride,N=t.settings,B=t.showRevisionInfo,j=t.stickerPacks,H=t.thirdPartySource,q=t.initialEditorFocus,z=t.hideOpenCloudDocMessage,Q=t.useDesignV2,Y=t.meatballMenu,G=a.default(m,{"sc-comment-stream":!0,"sc-comment-stream--right-rail":!!Q,"sc-comment-stream-enabled":M,"sc-comment-stream-all-changes-saved":!this.hasUnsavedChanges(),"sc-comment-stream-collapsed":L}),K=a.default({"sc-comment-stream-editor-container":this.includeEditorMeatball}),X=a.default({"sc-comment-stream-editor-bundle":this.includeEditorMeatball}),J=null,Z=null,$=W||U.formatMessage({id:"DkHo17",defaultMessage:"Enter your thoughts here"});if(this.includeEditor)J=_({a11yEditorLabel:$,author:R,className:"sc-comment-stream-editor",content:this.state.content,placeholder:$,postSignalComponent:this.renderPostBar,onCancel:this.onPrimaryEditorCancel,setDraftRef:this.setDraftRef,onPost:s,mentionsMatches:D,onMentionsQueryUpdated:r,onFocus:this.onPrimaryEditorFocus,onEditorStateChange:this.onPrimaryEditorStateChange,stickerPacks:j,shouldFocus:q,tagline:n.createElement(g.FirstPartyCommentAdvisory,{thirdPartySource:H,intl:U})});else if(!O){var ee=F?"google_doc":H;J=z?null:n.createElement(b.CloudDocMessage,{thirdPartySource:ee,openWith:this.props.openWith,intl:U})}return L&&(Z=n.createElement(C.Tooltip,{positioning:"left"},n.createElement(E.IconGlobal,{className:"sc-leave-a-comment-button",name:"comment",onClick:this.onLeaveACommentClick}))),n.createElement(A.RawIntlProvider,{value:U},n.createElement(k.CommentStreamContext.Provider,{value:this.state.context},n.createElement("div",{className:G,onClick:this.handleClick},Z,n.createElement("div",{className:K},n.createElement("div",{className:X},J,x&&n.createElement(y.CoachmarkLocation,Object.assign({name:y.CoachmarkLocations.ABOVE_COMMENT_STREAM},this.createCoachmarkProps("location"),{positions:this.state.coachmarkPositions}))),this.includeEditorMeatball&&Y),Q&&0===this.sortedVisibleThreads.length?n.createElement("div",{className:"sc-comment-empty-container"},n.createElement(P.Text,{size:"small",color:"faint"},U.formatMessage(T))):n.createElement(u.UnreadPillWrapper,{showUnreadPill:this.props.showUnreadPill,visibilityData:this.state.visibilityData,countMsgFn:function(e){return U.formatMessage({id:"fkNHq+",defaultMessage:"{count} unread"},{count:e})},onItemActivated:this.onThreadInteractedWith},n.createElement(f.VisibilityAwareScrollList,{className:"sc-comment-stream-threads",trackedItems:this.state.trackedItems,onVisibilityDataChange:this.onVisibilityDataChange},this.sortedVisibleThreads.map((function(t){return n.createElement(i.Thread,{ref:function(o){return e.setThreadRef(t.id,o)},key:t.id,actions:e.createThreadActions(t.id),active:t.id===S,focused:t.id===I||t.id===w,commentComponent:h,editedComment:e.state.editedComment,onThreadInteractedWith:e.onThreadInteractedWith,onCancel:e.onThreadReplyCancel,onStartEdit:e.onStartEdit,onEndEdit:e.onEndEdit,isMobile:O,thread:t,user:R,mentionsMatches:D,showRevisionInfo:B,streamSettings:N,stickerPacks:j,thirdPartySource:e.props.thirdPartySource,openWith:e.props.openWith,renderApprovalForm:e.props.renderApprovalForm,approvalFormStatus:e.props.approvalFormStatus})})))),x&&n.createElement(y.CoachmarkLocation,Object.assign({name:y.CoachmarkLocations.BELOW_COMMENT_STREAM},this.createCoachmarkProps("location"),{positions:this.state.coachmarkPositions})))))},t})(n.PureComponent);t.CommentStream=M,M.childContextTypes={localization:p.default.object,useV2Design:p.default.bool,showApproval:p.default.bool}}));
//# sourceMappingURL=comment_stream.min.js-vflCCNor_.map