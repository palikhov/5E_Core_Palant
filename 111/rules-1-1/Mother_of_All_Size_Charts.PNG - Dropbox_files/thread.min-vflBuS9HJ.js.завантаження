define(["require","exports","tslib","react","classnames","spectrum/tertiary_link/index","typescript/libraries/comments2/src/components/comment/index","typescript/libraries/comments2/src/components/thread/third_party_reply_cta","typescript/libraries/comments2/src/components/thread/thread_editor","typescript/libraries/comments2/src/components/thread/thread_source_message","prop-types","typescript/libraries/comments2/src/components/comment_editor/draft_utils","typescript/libraries/comments2/src/components/comment_utils","typescript/libraries/dbx-i18n/src/index","typescript/libraries/comments2/src/components/thread/thread_control_v2","dig-components/buttons","dig-components/icons","dig-components/icons/src","dig-components/tooltips","typescript/libraries/comments2/src/components/utils/approval_utils"],(function(e,t,o,n,r,s,i,a,d,l,c,p,m,u,h,f,v,g,E,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Thread=void 0,n=o.__importStar(n),r=o.__importDefault(r),c=o.__importDefault(c);var y=function(){},M=function(e,t){var o=t.localization.intl,r=e.count;o.formatMessage({id:"xj0qJi",defaultMessage:"{count, plural, one {# comment} other {# comments}}"},{count:r});var s=o.formatMessage({id:"NkhP8O",defaultMessage:"{count} comments"},{count:r});return n.createElement("div",{className:"sc-thread-comment-number"},s)};function C(e,t){return{onDeleted:function(){return t.onCommentDeleted(e.id)},onEdited:function(o){return t.onCommentEdited(e.id,o)},onMentionsQueryUpdated:t.onMentionsQueryUpdated,onClickAnnotation:t.onClickAnnotation,onClickOlderInfo:t.onClickOlderInfo,onApproverRespond:t.onApproverRespond,onEditApproval:t.onEditApproval,onDeleteApprovalComment:t.onDeleteApprovalComment,onResubmitApprovalFocus:t.onResubmitApprovalFocus}}M.contextTypes={localization:c.default.object};var T={type:"no_details"},A=(function(e){function t(){var t=e.apply(this,arguments)||this;return t.state={isEditorEmpty:!0,isEditorFocused:!1,shouldFocusThreadEditor:!1},t.ref=null,t.onFocusEditor=function(){return t.setState({isEditorFocused:!0})},t.onBlurEditor=function(){t.isApproval&&t.props.actions.onResubmitApprovalBlur(),t.setState({isEditorFocused:!1})},t.onClick=function(){var e=t.props;(0,e.onThreadInteractedWith)(e.thread)},t.handleKeyDown=function(e){13===e.which&&t.onClick()},t.onEditorStateChange=function(e){p.hasFocus(e)&&t.props.actions.onEditorFocused(),t.props.actions.onEditorStateChange(e),t.setState({isEditorEmpty:p.contentIsEmpty(e)})},t.setRef=function(e){t.ref=e},t.renderMarkedAsResolved=function(e){var o,r,s=t.intl,i="with_details"===e.type&&e;return i?(o=s.formatMessage({id:"seHweQ",defaultMessage:"Marked as resolved by {name}"},{name:i.resolver.name.display}),r=u.timeSince(s,i.resolvedTimestamp,{displayLocation:"label",displayContext:"standalone"})):(o=s.formatMessage({id:"0FvFw6",defaultMessage:"Marked as resolved"}),r=s.formatMessage({id:"0FvFw6",defaultMessage:"Marked as resolved"})),n.createElement(E.Tooltip,{placement:"top",title:r},n.createElement("div",{className:"sc-thread-controls-resolved-note"},o))},t.getResolvedInfo=function(e){var t=e.resolvedInfo,o=e.resolved;return t||(o?T:void 0)},t.getCommentControlsV2=function(){var e=t.props,o=e.thread,r=e.actions,s=e.streamSettings,i=e.active,a=e.isMobile,d=t.getResolvedInfo(o);return t.useV2Design&&!d?n.createElement(h.ThreadControlV2,{thread:o,actions:r,streamSettings:s,active:i,isMobile:a,intl:t.intl,showApproval:t.showApproval,isApproval:t.isApproval}):null},t}return o.__extends(t,e),Object.defineProperty(t.prototype,"intl",{get:function(){return this.context.localization.intl},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"useV2Design",{get:function(){return this.context.useV2Design},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"showApproval",{get:function(){return this.context.showApproval},enumerable:!1,configurable:!0}),t.prototype.componentDidMount=function(){var e=this;this.props.active&&this.scrollToThread(!1).then((function(){e.ref&&e.ref.focus()}))},t.prototype.componentDidUpdate=function(e){if(this.props.active&&!e.active){var t=this.props.streamSettings.canComment;this.scrollToThread(t)}else!this.props.active&&e.active&&this.setState({isEditorFocused:!1,shouldFocusThreadEditor:!1})},t.prototype.scrollToThread=function(e){var t=this,o=this.props.scrollToElem,n=this.ref;return n&&o?o(n).then((function(){t.ref&&t.setState({shouldFocusThreadEditor:e})})):Promise.resolve()},Object.defineProperty(t.prototype,"innerRef",{get:function(){return this.ref},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"activeOrEditorHasText",{get:function(){return this.props.active||!this.state.isEditorEmpty},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"className",{get:function(){var e=this.props,t=e.className,o=void 0===t?"":t,n=e.thread,s=e.isMobile,i=e.focused,a=n.resolved||n.resolvedInfo;return r.default(o,{"sc-thread":!0,"sc-thread--right-rail":this.context.useV2Design,"sc-thread-active":this.activeOrEditorHasText,"sc-thread-inactive":!this.activeOrEditorHasText,"sc-thread-read":n.read,"sc-thread-unread":!n.read,"sc-thread-resolved":a,"sc-thread-unresolved":!a,"sc-thread-mobile":s,"sc-thread-focused":i,"sc-thread-editor-is-focused":this.state.isEditorFocused})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"filteredReplies",{get:function(){return this.props.thread.comments.slice(1).filter((function(e){return!e.deleted}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"includeEditor",{get:function(){var e=this.props,t=e.streamSettings.canShowEditor,o=e.isMobile,n=e.thread.isThirdParty,r=e.approvalFormStatus,s=this.showApproval&&this.isApproval;return t&&!o&&!n&&(!s||"request_resubmit"===(null==r?void 0:r.activeForm))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isDisabled",{get:function(){return!!this.props.thread.pending},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isApproval",{get:function(){return b.isApprovalThread(this.props.thread)},enumerable:!1,configurable:!0}),t.prototype.renderComment=function(e,t,o,r,s,a){var d;void 0===o&&(o=i.Comment);var l=this.props,c=l.actions,p=l.editedComment,u=l.mentionsMatches,h=l.onStartEdit,f=l.onEndEdit,v=l.isMobile,g=l.showRevisionInfo,E=l.approvalFormStatus,b=l.thread,y=!!p&&e.id===p.id,M=!!(null==E?void 0:E.activeForm)&&E.threadId===b.id&&(null===(d=E.editArgs)||void 0===d?void 0:d.commentId)===e.id,T=!!(null==E?void 0:E.activeForm)&&E.threadId===b.id,A={actions:C(e,c),active:t,annotation:s,comment:e,isEditing:y,onStartEdit:h,onEndEdit:f,mentionsMatches:u,isMobile:v,showRevisionInfo:g,commentControls:a,isLatestReply:r,isEditingApproval:M,isApprovalOpen:T};return t||this.useV2Design?n.createElement(o,Object.assign({},A,{key:e.id})):n.createElement(m.TruncatedComment,{comment:e,key:e.id},(function(e){return n.createElement(o,Object.assign({},A,{comment:e}))}))},t.prototype.renderReadToggle=function(){var e=this.intl,t=this.props,o=t.actions,r=t.thread,i=r.read?o.onMarkAsUnread:o.onMarkAsRead,a=r.read?e.formatMessage({id:"rqoF7x",defaultMessage:"Mark as unread"}):e.formatMessage({id:"3OnFd5",defaultMessage:"Mark as read"});return n.createElement(E.Tooltip,{placement:"top",title:a},n.createElement(s.TertiaryLink,{className:"sc-thread-toggle",onClick:i,disabled:this.isDisabled},a))},t.prototype.renderToplineControls=function(){var e=this.intl,t=this.useV2Design,o=this.props,r=o.streamSettings,i=o.isMobile,a=o.actions,d=o.thread,l=this.activeOrEditorHasText;if(i)return null;var c=l&&r.canModifyThreads&&!d.isThirdParty,p=this.getResolvedInfo(d);return p?n.createElement("div",{className:"sc-thread-controls"},this.renderMarkedAsResolved(p),c&&n.createElement(E.Tooltip,{placement:"top",title:e.formatMessage({id:"8bWrbN",defaultMessage:"Restore"})},t?n.createElement(f.IconButton,{variant:"transparent",size:"small",onClick:a.onUnresolve,disabled:this.isDisabled},n.createElement(v.UIIcon,{src:g.RestoreLine,size:"small"})):n.createElement(s.TertiaryLink,{className:"sc-thread-toggle",disabled:this.isDisabled,onClick:a.onUnresolve},e.formatMessage({id:"8bWrbN",defaultMessage:"Restore"})))):c&&!this.useV2Design?n.createElement("div",{className:"sc-thread-controls"},this.renderReadToggle(),n.createElement(E.Tooltip,{placement:"top",title:e.formatMessage({id:"g5XGac",defaultMessage:"Resolve"})},n.createElement(s.TertiaryLink,{className:"sc-thread-toggle",onClick:a.onResolve,disabled:this.isDisabled},e.formatMessage({id:"g5XGac",defaultMessage:"Resolve"})))):null},t.prototype.renderActive=function(){var e=this,t=this.intl,o=this.props,r=o.actions,s=r.onMentionsQueryUpdated,l=r.onMouseEnter,c=r.onMouseLeave,p=r.onReply,m=r.onResubmitApprovalRequest,u=o.commentComponent,h=o.mentionsMatches,f=o.stickerPacks,v=o.onCancel,g=o.openWith,E=o.thirdPartySource,M=o.thread,C=o.user,T=o.renderApprovalForm,A=this.filteredReplies,R=b.getApproverDisplayName(M);return n.createElement("li",{onMouseEnter:l,onMouseLeave:c,className:this.className,tabIndex:0,role:"button","aria-expanded":!0,"aria-label":M.read?t.formatMessage({id:"/pyeDm",defaultMessage:"Comment thread"}):t.formatMessage({id:"vFb6Ur",defaultMessage:"Unread comment thread"}),ref:this.setRef,onClick:this.onClick},this.renderToplineControls(),n.createElement("ul",{className:"sc-thread-comments"},this.renderComment(M.comments[0],this.activeOrEditorHasText,u,0===A.length,M.annotation,this.getCommentControlsV2()),A.map((function(t,o){return e.renderComment(t,!0,i.Comment,o===A.length-1)})),this.showApproval&&T&&T(["respond","response_edit","request_edit"])),this.includeEditor&&(this.showApproval&&this.isApproval?n.createElement(d.ThreadEditor,{author:C,disabled:this.isDisabled,shouldFocus:this.state.shouldFocusThreadEditor,mentionsMatches:{},onCancel:v,onEditorStateChange:this.onEditorStateChange,onMentionsQueryUpdated:y,onPost:function(e){var t={type:"approval",status:"pending",approval_type:"request",actor:"requester",approver_display_name:R};m({text:e.text,metadata:[t]})},onFocus:this.onFocusEditor,onBlur:this.onBlurEditor,postLabel:t.formatMessage({id:"62bfQA",defaultMessage:"Resubmit request"}),placeholder:t.formatMessage({id:"CqEWQQ",defaultMessage:"Respond to {approver}"},{approver:R}),mentionsDisabled:!0}):n.createElement(d.ThreadEditor,{author:C,disabled:this.isDisabled,shouldFocus:this.state.shouldFocusThreadEditor,mentionsMatches:h,onCancel:v,onEditorStateChange:this.onEditorStateChange,onMentionsQueryUpdated:s,onPost:p,onFocus:this.onFocusEditor,onBlur:this.onBlurEditor,stickerPacks:f})),n.createElement(a.ThirdPartyReplyCTA,{intl:t,thirdPartySource:M.isThirdParty?E:void 0,openWith:g}))},t.prototype.renderInactive=function(){var e=this.intl,t=this.props,o=t.actions,r=o.onMouseEnter,s=o.onMouseLeave,a=o.onFocus,d=o.onBlur,c=t.active,p=t.commentComponent,u=void 0===p?i.Comment:p,h=t.mentionsMatches,f=t.thread,v=t.isMobile,g=t.showRevisionInfo,E=t.thirdPartySource,b=this.filteredReplies;return n.createElement("li",{className:this.className,tabIndex:0,"aria-label":f.read?e.formatMessage({id:"/pyeDm",defaultMessage:"Comment thread"}):e.formatMessage({id:"vFb6Ur",defaultMessage:"Unread comment thread"}),role:"button","aria-expanded":!1,onClick:this.onClick,onKeyDown:this.handleKeyDown,onMouseEnter:r,onMouseLeave:s,onFocus:a,onBlur:d,ref:this.setRef},this.renderToplineControls(),n.createElement("ul",{className:"sc-thread-comments"},this.renderComment(f.comments[0],c,u,0===b.length,f.annotation),b.length>1&&n.createElement(M,{count:b.length-1}),b.length>0&&(this.useV2Design?n.createElement(i.Comment,{active:!1,comment:b[b.length-1],actions:{onClickAnnotation:y,onDeleted:y,onEdited:y,onMentionsQueryUpdated:y,onClickOlderInfo:y,onApproverRespond:y,onResubmitApprovalFocus:y},mentionsMatches:h,onEndEdit:y,onStartEdit:y,isEditing:!1,isMobile:v,showRevisionInfo:g,isLatestReply:!0,isEditingApproval:!1}):n.createElement(m.TruncatedComment,{comment:b[b.length-1]},(function(e){return n.createElement(i.Comment,{active:!1,comment:e,actions:{onClickAnnotation:y,onDeleted:y,onEdited:y,onMentionsQueryUpdated:y,onClickOlderInfo:y,onApproverRespond:y,onResubmitApprovalFocus:y},mentionsMatches:h,onEndEdit:y,onStartEdit:y,isEditing:!1,isMobile:v,showRevisionInfo:g,isLatestReply:!0,isEditingApproval:!1})})))),this.includeEditor&&!this.useV2Design&&n.createElement("div",{className:"sc-thread-reply-hint"},e.formatMessage({id:"cBx2hi",defaultMessage:"Reply…"})),n.createElement(l.ThreadSourceMessage,{thirdPartySource:f.isThirdParty?E:void 0,intl:e}))},t.prototype.render=function(){return this.props.thread.comments.every((function(e){return!!e.deleted}))?null:this.activeOrEditorHasText?this.renderActive():this.renderInactive()},t})(n.PureComponent);t.Thread=A,A.contextTypes={localization:c.default.object,useV2Design:c.default.bool,showApproval:c.default.bool}}));
//# sourceMappingURL=thread.min.js-vflzPIcFB.map