define(["require","exports","api_v2/redux/file_viewer","file-viewer/watermarking/plugin/utils/index","file-viewer/watermarking/plugin/selectors","file-viewer/core/index"],(function(e,r,a,t,i,n){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.reloadWatermarkingHandler=r.analyticsMiddleware=r.handleWatermarkError=r.applyWatermark=void 0,r.applyWatermark=function(e){var r=e.dispatch,n=e.getState;return function(e){return function(o){if("ApplyWatermark"===o.type){var l=o.payload,s=l.fileViewerId,d=l.file,u=l.overwrite,f=n(),c=f.mode,p=f.textWatermarkOptions,v=f.imageWatermarkOptions,m=c[s],g=p[s],_=v[s],w=i.getCurrentWatermarkOptions(s,n()),y=w.position,k=w.marginX,x=w.marginY,h={path:d.fileId,overwrite:u};if("REPEAT"===y){var W=t.tilingFunc({scale:g.scale,mode:m,textWatermarkOptions:g,imageWatermarkOptions:_}),I=W.canvas,M=W.distanceX,E=W.distanceY,P=W.startX,O=W.startY,q=W.offsetXPerRow,F=W.offsetYPerCol;if(null==(T=t.canvasToImage(I)))return;h.tiled_image={image:T,distance_x:Math.round(M),distance_y:Math.round(E),start_x:Math.round(P),start_y:Math.round(O),offset_x_per_row:Math.round(q),offset_y_per_col:Math.round(F)}}else{var T;I=void 0;if("text"===m){var j=g.text,S=g.size,X=g.scale,Y=g.fontFamily,z=g.color,A=g.opacity,V=g.angle;I=t.drawTextTile({text:j,size:S*X,fontFamily:Y,color:z,opacity:A,angle:V}).canvas}else{var b=_.image;S=_.size,X=_.scale,A=_.opacity,V=_.angle;if(null==b)return;I=t.drawImageTile({image:b,scale:S*X,opacity:A,angle:V}).canvas}if(null==(T=t.canvasToImage(I)))return;h.image_watermark={image:T,position:y,margin_x:Math.round(k),margin_y:Math.round(x)}}r(a.watermarkingWatermarkFileAction({arg:h},{fileViewerId:s,fqPath:d.fqPath}))}e(o)}}},r.handleWatermarkError=function(e){return function(){return function(r){return function(a){"@@apiv2_redux/file_viewer/watermarking/watermark_file_result"===a.type&&a.error&&(a.error=new t.WatermarkingError(e,a.error)),r(a)}}}},r.analyticsMiddleware=function(e){return function(r){var a=r.getState;return function(r){return function(t){if("LogWorkflowEvent"===t.type){var i=t.payload,o=i.fileViewerId,l=i.eventName,s=a().loggingSession[o],d=s.file,u=s.filePreviewSessionId,f={source_action:"click",source_context:"file_viewer"};null!=t.payload.extra&&Object.keys(t.payload.extra).forEach((function(e){if(null!=t.payload.extra){var r=e,a=t.payload.extra[r];null!=a&&(f[r]=a)}})),e.log(l,{file_viewer_session_id:o,file_preview_session_id:u,file_id:null==d?void 0:d.fileId,sj_id:null==d?void 0:d.sjId,ns_id:null==d?void 0:d.nsId,device_type:"desktop",file_extension:d?n.getWhitelistedFileExtension(n.getFileExtension(d.name)):void 0,extra:f})}r(t)}}}},r.reloadWatermarkingHandler=function(e){return function(r){return function(r){return function(a){var t;if("@@apiv2_redux/file_viewer/watermarking/watermark_file_result"===a.type&&!a.error&&a.payload.result){var i=r(a),n=a.payload.result.fq_path||(null===(t=a.meta)||void 0===t?void 0:t.fqPath);return e({fqPath:n,overwrite:a.payload.arg.overwrite}),i}return r(a)}}}}}));
//# sourceMappingURL=middlewares.min.js-vfl9Wf4jw.map