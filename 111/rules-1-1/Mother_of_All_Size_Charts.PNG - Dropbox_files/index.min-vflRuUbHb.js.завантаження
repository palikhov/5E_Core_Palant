define(["require","exports","tslib","react","react-redux","api_v2/redux/comments2","api_v2/redux/media_addon","file-viewer/comments2/plugin/layer/index","file-viewer/comments2/plugin/pane","file-viewer/comments2/plugin/sidebar_control","typescript/component_libraries/files_components/src/blades/comments/index","typescript/component_libraries/flows/src/components/approval-forms/index","file-viewer/comments2/plugin/snackbar","typescript/component_libraries/files_components/src/blades/comments/data/store","file-viewer/comments2/logging_middleware","file-viewer/comments2/plugin/navigation_middleware","file-viewer/core/index","typescript/component_libraries/files_components/src/blades/comments/data/types","file-viewer/comments2/plugin/markers","file-viewer/keyboard/index","ts-keycode-enum","typescript/libraries/comments2/src/components/utils/thread_utils"],(function(e,t,i,n,r,a,o,s,l,d,c,u,m,p,f,g,v,h,I,_,C,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Comments2Plugin=t.DEFAULT_COMMENTS_CONFIGURATION=t.COMMENTS_PLUGIN_ID=void 0,n=i.__importStar(n),t.COMMENTS_PLUGIN_ID="comments",t.DEFAULT_COMMENTS_CONFIGURATION={showCommentsMeatball:!1,isInBladeRightRail:!1,showApproval:!1};var w=function(e,w,x,y){var A=this;void 0===x&&(x={}),this.didRequestComments=!1,this.didRequestfocus=!1,this.didRequestActivateThread=!1,this.loadMediaFeatures=function(){return i.__awaiter(A,void 0,void 0,(function(){var e,t,n,r;return i.__generator(this,(function(i){switch(i.label){case 0:e=void 0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.platform.apiv2ClientBase.ns("media_addon").rpc("get_features",e,{})];case 2:return t=i.sent(),this.store.dispatch(o.getFeaturesResultAction({result:t,arg:e})),null!=(n=t.frame_precise_comments)&&this.context.getPluginData().navigation.toggleVideoFrameSteppers(n),[3,4];case 3:return r=i.sent(),this.store.dispatch(o.getFeaturesResultAction({arg:e},null,r)),[3,4];case 4:return[2]}}))}))},this.isSupported=function(e){return"cloud_doc"!==v.resolvePreviewTypeFromExtension(v.getFileExtension(e.name))},this.handleCancelAnnotating=function(){A.store.getState().annotationState&&A.store.dispatch(c.cancelAnnotating(A.context.fileViewerId))},this.layerUI={LayerWithEventBubbling:function(e){return n.createElement(r.Provider,{store:A.store},n.createElement(s.AnnotationLayer,Object.assign({platform:A.platform,context:A.context,config:A.config},e)))}},this.rightRailUI={Control:function(e){var i,a;return e.file&&A.isSupported(e.file)?A.config.isInBladeRightRail?n.createElement(r.Provider,{store:A.store},n.createElement(c.CollapsedCommentsBladeButton,{id:t.COMMENTS_PLUGIN_ID,intl:A.platform.intl,fileId:null===(i=e.file)||void 0===i?void 0:i.fileId,sharedLinkURL:null===(a=e.sharedLinkInfo)||void 0===a?void 0:a.url})):n.createElement(r.Provider,{store:A.store},n.createElement(d.CommentsPluginSidebarControl,Object.assign({platform:A.platform,context:A.context,config:A.config},e))):null},Header:function(){var e=A.context.getPluginData().previewType;return n.createElement(r.Provider,{store:A.store},n.createElement(m.AnnotationSnackbar,{fileViewerId:A.context.fileViewerId,previewType:e}))},VideoSeekBarLayer:function(e){return n.createElement(r.Provider,{store:A.store},n.createElement(I.CommentMarkers,Object.assign({},e)))},Sidebar:function(e){var i;return A.isSupported(e.file)?A.config.isInBladeRightRail?n.createElement(r.Provider,{store:A.store},n.createElement(_.KeyboardBindingConnector,{keyboardBindings:A.keybinding}),n.createElement(c.CommentsBlade,{id:t.COMMENTS_PLUGIN_ID,intl:A.platform.intl,fileId:e.file.fileId,sharedLinkURL:null===(i=e.sharedLinkInfo)||void 0===i?void 0:i.url,showApproval:A.config.showApproval,approvalsLogger:function(){var t;null===(t=A.approvalIOClient)||void 0===t||t.getLogger().logRequestApprovalClick(e.file.sjId,e.file.nsId,v.getFileExtension(e.file.name),e.file.fqPath,e.file.fileId)}},n.createElement(l.CommentsPluginPane,Object.assign({getAccountData:A.promisedAccount,intl:A.platform.intl,context:A.context,config:A.config,approvalIOClient:A.approvalIOClient},e)))):n.createElement(r.Provider,{store:A.store},n.createElement(l.CommentsPluginPane,Object.assign({getAccountData:A.promisedAccount,intl:A.platform.intl,context:A.context,config:A.config,approvalIOClient:A.approvalIOClient},e))):null},mediaScrubber:{onClickOutsideMarkers:function(){A.store.dispatch(c.deactivateAllThreads({fileViewerId:A.context.fileViewerId}))},markers:function(e,t){var n=A.store.getState().threads[h.createCommentFileIdentifier(e,t)];return n?Object.values(n).reduce((function(n,r){var a=(function(e){var t;switch(null===(t=e.annotation)||void 0===t?void 0:t.type){case"audio":case"video":return e.annotation.time;default:return}})(r);return void 0===a?n:i.__spreadArrays(n,[{time:a,onClick:function(){A.store.dispatch(c.activateThread({fileId:e,sharedLinkURL:t,fileViewerId:A.context.fileViewerId,isThirdParty:r.isThirdParty,threadId:r.id}))}}])}),[]):[]}}},this.lifecycle={previewWillInitialize:function(e,t,i){if(A.didRequestComments=!1,"fileId"in e){if(t){var n={include_permissions:!0,stream:{identifier:{".tag":"shared_link_details",url:t.url},type:{".tag":"file"}}};i?A.store.dispatch(a.loggedOutListCommentsAction({arg:n})):A.store.dispatch(a.listCommentsAction({arg:n}))}else A.store.dispatch(a.listCommentsAction({arg:{include_permissions:!0,stream:{identifier:{".tag":"file_path_or_id",file_path_or_id:e.fileId},type:{".tag":"file"}}}}));A.didRequestComments=!0}},previewDidInitialize:function(e){var t,i=e.threadId,n=e.shouldFocusApproval,r=e.shouldFocusComment,o=e.commentId,s=A.context.getPluginData(),l=s.file,d=s.sharedLinkInfo;if(null==l)throw new Error("Expected non-null file when preview initialized");if(A.didRequestComments||(A.store.dispatch(a.listCommentsAction({arg:{include_permissions:!0,stream:{identifier:{".tag":"file_path_or_id",file_path_or_id:l.fileId},type:{".tag":"file"}}}})),A.didRequestComments=!0),"string"!=typeof i||A.didRequestActivateThread){if("string"==typeof o&&!A.didRequestActivateThread){A.context.getPluginData().navigation.openSidebar("sidebar");var m=(null==d?void 0:d.url)||l.fileId,p=Object.values(A.store.getState().threads[m]),f=b.findCommentThread(p,o);f&&A.store.dispatch(c.activateThread({fileId:l.fileId,sharedLinkURL:null==d?void 0:d.url,fileViewerId:A.context.fileViewerId,threadId:f.thread.id,isThirdParty:f.thread.isThirdParty})),A.didRequestActivateThread=!0}}else A.context.getPluginData().navigation.openSidebar("sidebar"),A.store.dispatch(c.activateInitialThread({fileViewerId:A.context.fileViewerId,threadId:i,fileId:l.fileId})),A.didRequestActivateThread=!0;n&&A.store.dispatch(u.setApprovalForm(((t={})[l.fileId]={activeForm:"request",threadId:void 0},t))),r&&!A.didRequestfocus&&(A.context.getPluginData().navigation.openSidebar("sidebar"),A.store.dispatch(c.focusEditor(A.context.fileViewerId)),A.didRequestfocus=!0)},previewWillTeardown:function(){null!=A.store.getState().annotationState&&A.store.dispatch(c.cancelAnnotating(A.context.fileViewerId))}};var E=g.createMiddleware(w);this.store=p.makeStore({apiv2ClientBase:e.apiv2ClientBase,boltIOClient:y.boltIOClient,mentionsIOClient:y.mentionsIOClient,logger:function(e){w.logUserAction({action:e.event,context:"right_sidebar"})}},[E,f.middleware]),this.platform=e,this.context=w,this.config=i.__assign(i.__assign({},t.DEFAULT_COMMENTS_CONFIGURATION),x),this.approvalIOClient=y.approvalIOClient,this.keybinding=_.getKeyboardBinding({keyCode:C.Key.Escape,callback:this.handleCancelAnnotating}),this.promisedAccount=e.apiv2ClientBase.ns("users").rpc("get_current_account",void 0,{}),this.loadMediaFeatures()};t.Comments2Plugin=w}));
//# sourceMappingURL=index.min.js-vflTOEJLJ.map