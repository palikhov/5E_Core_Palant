define(["require","exports","tslib","modules/clean/deprecated_ajax/ajax_jquery","lodash","modules/core/i18n","modules/core/cookies","modules/core/notify","modules/core/uri","api_v2/transport/fetch","modules/clean/react/components/modal","modules/clean/react/extensions/auth_modal","modules/clean/filepath/filepath","modules/clean/react/extensions/cloud_docs_compat","modules/clean/cloud_docs/event_logging","modules/clean/cloud_docs/open_with_utils"],(function(e,t,r,i,n,o,a,c,s,u,d,l,_,h,f,p){"use strict";function m(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,o,c,d;return r.__generator(this,(function(r){if(n=new u.FetchAsyncTransport,o=new s.URI({scheme:"https",authority:"www.dropbox.com",path:"/2/app_actions/"+t}),(c={})["X-Dropbox-Path-Root"]=e.root_ns_id.toString(),c["X-Dropbox-Uid"]=e.id.toString(),!(d=a.Cookies.read("__Host-js_csrf")))throw new Error("No CSRF cookie");return(c["X-CSRF-Token"]=d,[2,n.executeRpc(o,c,JSON.stringify(i),"application/json")])}))}))}function w(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,m(e,t,i)];case 1:return n=r.sent(),o={request_id:n.headers["x-dropbox-request-id"],redirect_url:n.result.redirect_url},"link_state"in n.result&&(o.link_state=n.result.link_state),[2,o]}}))}))}function g(e,t,i,n,o){return r.__awaiter(this,void 0,void 0,(function(){var a;return r.__generator(this,(function(r){switch(r.label){case 0:return a=function(){return w(e,"redirect",{action_id:t,file_ids:n})},[4,x(e,t,i,n[0],a,o)];case 1:return r.sent(),[2]}}))}))}function v(e,t){if(1!==e.length)throw new Error("Expected single file: "+t);return e[0]}function b(e,t,i,n,o){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,x(e,t,i,n,(function(){return w(e,"authorize",{action_id:t,file_id:n})}),o)];case 1:return[2,r.sent()]}}))}))}function x(e,t,a,s,u,d){return r.__awaiter(this,void 0,Promise,(function(){function l(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,u()];case 1:return[2,e.sent()];case 2:return e.sent(),f=!0,[2,void 0];case 3:return[2]}}))}))}var _,h,f,p,m,w,g,v;return r.__generator(this,(function(r){switch(r.label){case 0:return _="action_redirect_"+Math.random().toString(16).substring(2),(h=window.open("",_,d))&&(h.document.open("text/html","replace"),h.document.write("<html><head><title>"+n.escape(a)+"</title></head></html>"),h.document.close()),f=!1,p=new Promise((function(r){i.SilentBackgroundRequest({url:"/aa/loading",subject_user:e.id,data:{file_id:s,action_id:t},success:function(e){!f&&h?(h.document.open("text/html","replace"),h.document.write(e),h.document.close(),h.document.title=a,r()):r()},error:function(){r()}})})),[4,Promise.all([p,l()])];case 1:return m=r.sent(),w=m[1],g=w&&w.redirect_url||"/aa/error",h?h.location.replace(g):window.open(g,"_blank",d)||(v=a,c.Notify.error(o.intl.formatMessage({id:"TFhSer",defaultMessage:"Failed to open {app_name}"},{app_name:v}))),[2,w]}}))}))}Object.defineProperty(t,"__esModule",{value:!0}),t.showLoadingPageAndDoRedirect=t.authAction=t.redirectToActionOrShowAuth=t.redirectToAction=t.authorizeNoRedirect=t.fetchUrl=t.fetch=void 0,i=r.__importStar(i),n=r.__importStar(n),_=r.__importStar(_),t.fetch=m,t.fetchUrl=w,t.authorizeNoRedirect=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,m(e,"authorize_no_redirect",{action_id:t})];case 1:return[2,(i=r.sent())&&i.result&&i.result.link_state];case 2:return r.sent(),[2,null];case 3:return[2]}}))}))},t.redirectToAction=g,t.redirectToActionOrShowAuth=function(e,t,i,n,o,a,c){return r.__awaiter(this,void 0,void 0,(function(){var n,s,u,m,w,x,S,k,y,A;return r.__generator(this,(function(R){if("redirect"===i.handler[".tag"])n=i.handler.window_params,s=void 0,"popup"===n[".tag"]&&(u=n.width,m=n.height,s="width="+u+",height="+m),"sfa_unlinked"===i.link_state[".tag"]&&!i.id.startsWith("fp_action_id:")?(w=v(t,"first party actions do not support multiple files yet."),x=_.filename(w.ns_path),l.showAuthModal(i.id,i.description,i.icon.url,w.file_id,x,(function(){d.Modal.close(),(function(e,t,i,n,o,a){r.__awaiter(this,void 0,void 0,(function(){var c;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,b(e,t,i,n,o)];case 1:return c=r.sent(),a&&c&&c.link_state&&a(t,c.link_state),[2]}}))}))})(e,i.id,i.description,w.file_id,s,a)}))):(S=t.map((function(e){return e.file_id})),g(e,i.id,i.description,S,s));else if("cloud_editor"===i.handler[".tag"])A=v(t,"cloud docs actions do not support multiple files yet."),k=o?f.getActionSourceFromSurface(o.surface):void 0,y=h.cloudEditorNameToParams(i.handler.editor_name),p.openWithCloudEditor(p.fileToOpenWithParams(A),e.id,y,!1,k);else{if("profile_service"!==i.handler[".tag"])throw new Error('Unexpected handler "'+i.handler[".tag"]+'"');c&&(A=v(t,"profile service actions do not support multiple files yet."),c(e,A,i))}return[2]}))}))},t.authAction=b,t.showLoadingPageAndDoRedirect=x}));
//# sourceMappingURL=redirect.min.js-vflYlXo3w.map