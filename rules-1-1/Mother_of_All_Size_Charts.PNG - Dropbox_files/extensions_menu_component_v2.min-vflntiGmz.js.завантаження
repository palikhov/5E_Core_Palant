define(["require","exports","tslib","classnames","react","react-redux","dig-components/buttons","dig-components/icons","dig-components/icons/src","dig-components/menu","dig-components/icons/src","spectrum/tooltip/index","modules/clean/file_store/utils","modules/clean/integrations/data/selectors","modules/clean/react/extensions/apis","modules/clean/react/extensions/shared_file_popover_content_component","modules/clean/react/app_actions/telemetry_client","modules/clean/react/components/css","modules/clean/react/extensions/data/action_creators","modules/clean/react/extensions/data/helpers","modules/clean/react/extensions/data/selectors","modules/clean/react/extensions/data/types","modules/clean/react/extensions/extensions_popover_content_component_v2","modules/clean/react/extensions/extensions_utils","modules/clean/react/extensions/file","modules/clean/react/extensions/tooltips","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/open_button/types","modules/clean/react/file_viewer/unity/with_unity","modules/core/i18n"],(function(e,n,t,o,i,r,s,a,l,c,p,u,d,f,g,m,h,v,_,y,x,I,S,E,C,w,T,A,P,b,B){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ExtensionsPopoverContent=n.ExtensionsMenuV2=n.ExtensionsMenuV2NoUnity=n.ExtensionsMenuV2Component=void 0,o=t.__importDefault(o);var D=(function(e){function r(o){var r=e.call(this,o)||this;return r.handleButtonClick=function(e){e.preventDefault(),e.stopPropagation()},r.handleMenuClick=function(e){e.preventDefault(),e.stopPropagation()},r.handleHover=function(){r.currentSession&&r.currentSession.event("trigger_hover")},r.setBigTooltip=function(e){return t.__awaiter(r,void 0,void 0,(function(){var n,o,i,r,s,a,l,c,p;return t.__generator(this,(function(t){switch(t.label){case 0:return n=this.props,o=n.file,i=n.appActions,r=n.featureFlags,s=C.getFileExt(o)||"",(a=i.length>0)?[4,g.getTooltipHistory(e,["open_with_edu"])]:[3,2];case 1:l=t.sent(),c=w.allowedTooltips(a,s,r),p=c.find((function(e){return void 0!==l[e]&&!l[e]})),this.setState({bigTooltipName:p}),t.label=2;case 2:return[2]}}))}))},r.markBigTooltipViewed=function(){var e=!1,n=[];r.state.bigTooltipName&&(n.push(g.markTooltipViewed(r.props.user.id,r.state.bigTooltipName)),e=!0),e&&(Promise.all(n).then((function(){r.props.showBigTooltip&&r.setBigTooltip(r.props.user.id)})),r.setState({bigTooltipName:void 0}))},r.handleSelectAction=function(e,n){n.preventDefault(),e.handler(),r.props.onExtensionClick&&r.props.onExtensionClick(e.actionName||e.userAction),r.logToPreviews(e,!1),n.stopPropagation()},r.logToPreviews=function(e,n){if(r.props.telemetryContext&&"previews"===r.props.telemetryContext.surface&&e.userAction){var t=n?T.UserActionContext.TitleBarMain:T.UserActionContext.TitleBarSplitButton,o=e.actionName?{app_action_name:e.actionName}:{};d.isBrowseFile(r.props.file)&&r.props.file.read_only&&(o.readOnly=!0),A.logUserAction(e.userAction,t,o)}},r.renderTrigger=function(e){var n=r.props.triggerType,o="app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",l=B.intl.formatMessage({id:"z5t3Bh",defaultMessage:"Open"}),c=n===I.TriggerType.OpacityButton?i.default.createElement(s.Button,t.__assign({variant:"opacity",withDropdownIcon:!0},e),l):n===I.TriggerType.CollapsedButton?i.default.createElement(u.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:B.intl.formatMessage({id:"KEegJt",defaultMessage:"Open With"})},i.default.createElement(s.IconButton,t.__assign({variant:"transparent",className:o},e),i.default.createElement(a.UIIcon,{src:p.OpenLine,"aria-label":l}))):i.default.createElement(s.Button,t.__assign({className:o,variant:n&&n!==I.TriggerType.SecondaryButton?"primary":"opacity"},e),i.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},i.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},l+" â–¾")));return i.default.createElement("div",t.__assign({onMouseDown:r.markBigTooltipViewed,onMouseEnter:r.handleHover},e),c)},r.renderMenu=function(){return i.default.createElement(c.Menu.Wrapper,{className:"app-actions__unportaled-menu",onSelection:r.handleSelectAction,onToggle:r.onPopoverToggle,isPortaled:!0},(function(e){var o=e.getContentProps,s=e.getTriggerProps;return i.default.createElement(i.default.Fragment,null,r.renderTrigger(s({onClick:r.handleButtonClick})),i.default.createElement(c.Menu.Content,t.__assign({},o({}),{onClick:r.handleMenuClick,className:"app-actions-open-with-menu",placement:"bottom-end"}),i.default.createElement(n.ExtensionsPopoverContent,{user:r.props.user,file:r.props.file,unityInfo:r.props.unityInfo,extraOptions:r.props.extraOptions,sharingServiceInfo:r.props.sharingServiceInfo,refreshSharingServiceInfo:r.props.refreshSharingServiceInfo,onPresentInZoom:r.props.onPresentInZoom,currentSession:r.currentSession,telemetryContext:r.props.telemetryContext})))}))},r.onPopoverToggle=function(e){var n=e.isOpen;n&&r.props.onDropdownOpen?r.props.onDropdownOpen():!n&&r.props.onDropdownClose&&r.props.onDropdownClose(),r.currentSession&&r.currentSession.event(n?"open_popover":"close_popover")},r.onDownloadClick=function(e){return function(n){n.preventDefault(),n.stopPropagation(),e.handler(),r.logToPreviews(e,!0)}},r.state={},r.telemetryClient=h.createTelemetryClient({component:"menu_v2"}),r}return t.__extends(r,e),r.prototype.componentDidMount=function(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)},r.prototype.render=function(){var e=this.props,n=e.file,r=e.appActions,c=e.featureFlags,p=e.telemetryContext,u=e.triggerType,f=e.showAsButtonIfDownloadOnly,g=e.hasOpenInPaperSupport,m=e.unityInfo,v=e.extraOptions,_=e.user,x=e.sharingServiceInfo,S=e.refreshSharingServiceInfo,w=e.onPresentInZoom,T=e.landingPagesEnabled,A=e.cloudDocsInfo;if(!n.file_id)return null;p?this.currentSession=this.telemetryClient.session({surface:p.surface,ext:h.getPiiSafeExtension(C.getFileExt(n)||""),feature_flags:c}):delete this.currentSession;var b=E.getOpenOptionsForFile({file:n,hasOpenInPaperSupport:g,unityInfo:m,extraOptions:v,user:_,sharingServiceInfo:x,refreshSharingServiceInfo:S,onPresentInZoom:w,landingPagesEnabled:T,isCloudEditorDisabled:!0,cloudDocsInfo:A,surface:null==p?void 0:p.surface}),D=u===I.TriggerType.CollapsedButton,F=b.length>0,O=!1;if(F&&1===b.length&&(F=!(O=b[0].type===P.OpenButtonAction.DOWNLOAD)),!F&&(0===r.length||d.isSharedFile(n)&&0===y.partitionActions(r).cloudEditors.length)){if(f&&O){var M={className:o.default("app-actions-download-button",{"app-actions-download-button--collapsed":D}),onClick:this.onDownloadClick(b[0])};return D?i.default.createElement(s.IconButton,t.__assign({variant:"transparent"},M),i.default.createElement(a.UIIcon,{name:"download-file",src:l.DownloadLine,"aria-label":B.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"})})):i.default.createElement(s.Button,t.__assign({variant:"opacity"},M),B.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}))}return null}return this.renderMenu()},r.displayName="ExtensionsMenuV2Component",r})((i=t.__importDefault(i)).default.Component);n.ExtensionsMenuV2Component=D;var F={updateLinkState:function(e,n){return _.updateLinkState({actionId:e,linkState:n})},refreshSharingServiceInfo:_.refreshSharingServiceInfoAdapter},O=r.connect((function(e,n){return{appActions:x.getOpenActionsForFile(e,n.file),bylines:x.getBylines(e),categoryInfos:x.getCategoryInfos(e),featureFlags:x.getFeatureFlags(e),cloudDocsInfo:x.getCloudDocInfo(e),landingPagesEnabled:f.isConnectServiceLandingPagesEnabled(e)}}),F),M=O(D);n.ExtensionsMenuV2NoUnity=v.requireCssWithComponent(M,["/static/css/app_actions/index-vfl6RtqH3.css","/static/css/dig-components/index.web-vflfsfj-g.css"]);var k=O((function(e){return d.isBrowseFile(e.file)?i.default.createElement(b.WithUnity,{file:e.file,user:e.user,render:function(n){return i.default.createElement(D,t.__assign({},e,{unityInfo:n}))}}):i.default.createElement(D,t.__assign({},e))}));n.ExtensionsMenuV2=v.requireCssWithComponent(k,["/static/css/app_actions/index-vfl6RtqH3.css","/static/css/dig-components/index.web-vflfsfj-g.css"]);var N=function(e){var n=e.file,t=e.user,o=e.telemetryContext,r=e.appActions,s=e.bylines,a=e.categoryInfos,l=e.featureFlags,c=e.updateLinkState,p=e.hasOpenInPaperSupport,u=e.unityInfo,f=e.extraOptions,g=e.sharingServiceInfo,v=e.refreshSharingServiceInfo,_=e.onPresentInZoom,x=e.landingPagesEnabled,I=e.cloudDocsInfo,w=e.isInActionBar,T=e.previewActionHandler,A=e.openDesktopActionHandler,P=e.goToFolderActionHandler,b=e.isCurrentFolderEligibleForAutomation,B=e.isSubfolderEligibleForAutomation,D=e.hideZipAction,F=e.replayActionHandler,O=E.getCategoryIdToInfos(a),M=E.getOpenOptionsForFile({file:n,hasOpenInPaperSupport:p,unityInfo:u,extraOptions:f,user:t,sharingServiceInfo:g,refreshSharingServiceInfo:v,onPresentInZoom:_,landingPagesEnabled:x,isCloudEditorDisabled:!0,cloudDocsInfo:I,surface:null==o?void 0:o.surface,isInActionBar:w,previewActionHandler:T,openDesktopActionHandler:A,goToFolderActionHandler:P,isCurrentFolderEligibleForAutomation:b,isSubfolderEligibleForAutomation:B,hideZipAction:D,replayActionHandler:F}),k=o&&(e.currentSession||h.createTelemetryClient({component:"menu_v2"}).session({surface:o.surface,ext:h.getPiiSafeExtension(C.getFileExt(n)||""),feature_flags:l}));if(d.isBrowseFile(n)&&(r.length>0||M.length>0))return i.default.createElement(S.ExtensionsPopoverV2WithUnity,{file:n,user:t,openOptions:M,appActions:r,bylines:s,categoryIdToInfos:O,featureFlags:l,updateLinkState:c,telemetryContext:o,currentSession:k,isInActionBar:w});if(d.isSharedFile(n)){var N=y.partitionActions(r).cloudEditors;return i.default.createElement(m.SharedFilePopoverContent,{openOptions:M,cloudEditorAppActions:N,file:n,user:t,currentSession:k,isInActionBar:w})}return null};N.displayName="ExtensionsPopoverContentController",n.ExtensionsPopoverContent=O(N)}));
//# sourceMappingURL=extensions_menu_component_v2.min.js-vflCOO5es.map