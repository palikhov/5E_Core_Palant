define(["require","exports","tslib","react","typescript/component_libraries/files_components/src/blades/comments/data/adapter","typescript/libraries/comments2/src/components/comment_stream/comment_stream","react-redux","typescript/component_libraries/files_components/src/blades/comments/data/actions","typescript/component_libraries/files_components/src/blades/comments/data/transform","typescript/component_libraries/files_components/src/blades/comments/data/reducer","typescript/libraries/comments2/src/l10n","react-intl","reselect","typescript/component_libraries/files_components/src/blades/comments/component/meatball_menu","typescript/component_libraries/flows/src/components/approval-forms/index","dig-components/typography","typescript/component_libraries/files_components/src/blades/comments/data/selectors","typescript/libraries/comments2/src/components/types/utils","dig-components/progress_indicators"],(function(e,t,o,n,s,a,i,r,c,d,l,p,m,u,h,f,v,A,I){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestOnlyCommentsPane=t.CommentsBladePane=void 0,n=o.__importStar(n);var g=p.defineMessage({id:"Nsn7u9",defaultMessage:"Add your thoughts"}),b=p.defineMessage({id:"xu32KV",defaultMessage:"Your thoughts ..."}),C=p.defineMessage({id:"eqe9mn",defaultMessage:"Comments have been disabled for this file."}),S=(function(e){function t(t){var o=e.call(this,t)||this;return o.hasShownAuthModalOnFocus=!1,o.setCommentsActionsAdapter=function(e,t,n,a,i,r,c){var d=function(e){var t;"av"===(null===(t=o.props.navigation)||void 0===t?void 0:t.type)&&o.props.navigation.seek(e)},l=function(){var e;"av"===(null===(e=o.props.navigation)||void 0===e?void 0:e.type)&&o.props.navigation.pause()},p=function(){!i||o.state.account||o.hasShownAuthModalOnFocus||(o.hasShownAuthModalOnFocus=!0,i()),o.props.config.isInBladeRightRail||l()};e.then((function(e){null!=e?o.setState({account:e,isLoadingAccountInfo:!1,commentsActionAdapter:s.getCommentsActionsAdapter({dispatch:t,getAccount:function(){return e},getFileId:function(){return a},getSharedLinkInfo:function(){var e;return null!==(e=o.props.sharedLinkInfo)&&void 0!==e?e:null},getCommentsBladeId:function(){return n},onEditorFocused:p,seek:d,pause:l,approvalIOClient:r,onClickAnnotation:c})}):o.setState({isLoadingAccountInfo:!1,commentsActionAdapter:void 0})}),(function(e){o.setState({isLoadingAccountInfo:!1,commentsActionAdapter:s.getCommentsActionsAdapter({dispatch:t,getAccount:function(){},getFileId:function(){return a},getSharedLinkInfo:function(){var e;return null!==(e=o.props.sharedLinkInfo)&&void 0!==e?e:null},getCommentsBladeId:function(){return n},onEditorFocused:p,seek:d,showAuthModal:i,pause:l,approvalIOClient:r})})})).catch((function(){o.setState({isLoadingAccountInfo:!1})}))},o.threadComparator=function(e){return function(t,o){var n=A.isThreadWithTimecodeAnnotation(t)?t.annotation.time:0,s=A.isThreadWithTimecodeAnnotation(o)?o.annotation.time:0;return n!==s?n-s:e?+o.timestamp-+t.timestamp:+t.timestamp-+o.timestamp}},o.sortThreads=m.defaultMemoize((function(e,t){return void 0===t&&(t=!1),e?Object.values(e).sort(o.threadComparator(t)):[]})),o.getMeatballMenu=function(){var e=o.props,t=e.fileId,s=e.sharedLinkInfo,a=e.config;return n.createElement(u.CommentsMeatball,{fileId:t,sharedLinkURL:null==s?void 0:s.url,className:"comment-stream-meatball-icon",showApproval:a.showApproval})},o.state={account:null,commentsActionAdapter:void 0,commentsLocalization:l.getCommentsStrings(o.props.intl),isLoadingAccountInfo:!0},o.setCommentsActionsAdapter(o.props.getAccountData,o.props.dispatch,o.props.commentsBladeId,o.props.fileId,o.props.showAuthModal,o.props.approvalIOClient,o.props.onClickAnnotation),o}return o.__extends(t,e),t.prototype.componentDidUpdate=function(){var e;if(h.isRequestApproval()){var t=this.props,o=t.sharedLinkInfo,n=t.fileId,s=(null==o?void 0:o.url)||n;this.props.dispatch(h.setApprovalForm(((e={})[s]={activeForm:"request",threadId:void 0},e)))}if(this.state.commentsActionAdapter){var a=h.getApprovalCommentId();a&&this.state.commentsActionAdapter.onCommentActivated(a,Object.values(this.props.threads))}},t.prototype.componentDidMount=function(){this.props.boltInfo&&this.props.dispatch(r.boltSubscribe([this.props.boltInfo]))},t.prototype.componentWillUnmount=function(){this.props.boltInfo&&this.props.dispatch(r.boltUnsubscribe([this.props.boltInfo]))},t.prototype.UNSAFE_componentWillReceiveProps=function(e){e.dispatch===this.props.dispatch&&e.commentsBladeId===this.props.commentsBladeId&&e.fileId===this.props.fileId&&e.getAccountData===this.props.getAccountData&&e.showAuthModal===this.props.showAuthModal&&e.onClickAnnotation===this.props.onClickAnnotation||this.setCommentsActionsAdapter(e.getAccountData,e.dispatch,e.commentsBladeId,e.fileId,e.showAuthModal,e.approvalIOClient,e.onClickAnnotation),e.boltInfo!==this.props.boltInfo&&(this.props.boltInfo&&e.dispatch(r.boltUnsubscribe([this.props.boltInfo])),e.boltInfo&&e.dispatch(r.boltSubscribe([e.boltInfo]))),e.intl!==this.props.intl&&this.setState({commentsLocalization:l.getCommentsStrings(e.intl)})},t.prototype.render=function(){var e=this,t=this.props,i=t.activeThreadID,r=t.fileId,l=t.focusedThreadID,p=t.hoverThreadID,m=t.mentionsMatches,u=t.status,v=t.thirdPartySource,A=t.threads,S=t.intl,_=t.className,M=t.editorComponent,E=t.commentComponent,y=t.config,F=t.showResolvedComments,R=t.approvalFormStatus,T=t.approvalIOClient,w=t.commentsEnabled,L=t.sharedLinkInfo,D=this.state,O=D.account,B=D.commentsActionAdapter,k=D.commentsLocalization;if(null==B||void 0===u)return this.state.isLoadingAccountInfo||void 0===u?n.createElement("div",{className:"comments-blade-loading-spinner-container"},n.createElement(I.Spinner,{className:"comments-blade-loading-spinner",size:"standard","aria-valuetext":S.formatMessage({id:"csFB2E",defaultMessage:"Loading"})})):void 0;var N=this.sortThreads(A,y.isInBladeRightRail),P=O?c.accountToCommentStreamUser(O):{id:"dbid:guest_id",name:{display:"?",initials:"?",public:"?"}},q=y.isInBladeRightRail?S.formatMessage(g):S.formatMessage(b),U=u===d.Status.FullyEnabled?s.ENABLED_SETTINGS:s.READ_ONLY_SETTINGS,x=function(t,o){if(!T||!R||!R.activeForm)return null;var s=(null==L?void 0:L.url)||r;if(t.indexOf(R.activeForm)<=-1)return null;var a={intl:e.props.intl,ioClient:T,onCancel:function(){var t;e.props.dispatch(h.setApprovalForm(((t={})[s]={},t)))},fileId:r,user:{initials:P.name.initials,photoUrl:P.photoUrl},inlineWithComments:o};return"request"==R.activeForm?n.createElement(h.ApprovalRequestForm,Object.assign({},a,{onRequestSuccess:B.onAddApprovalSuccess})):"request_edit"==R.activeForm&&R.threadId&&R.editArgs?R.threadId!=i?null:n.createElement(h.ApprovalRequestForm,Object.assign({},a,{onEditSuccess:B.onEditApprovalSuccess,editArgs:R.editArgs,threadId:R.threadId})):"respond"==R.activeForm&&R.threadId?R.threadId!=i?null:n.createElement(h.ApprovalRespondForm,Object.assign({},a,{threadId:R.threadId,onRespondSuccess:B.onAddApprovalSuccess})):"response_edit"==R.activeForm&&R.threadId&&R.editArgs?R.threadId!=i?null:n.createElement(h.ApprovalRespondForm,Object.assign({},a,{threadId:R.threadId,editArgs:R.editArgs,onEditSuccess:B.onEditApprovalSuccess})):null};return!w&&y.isInBladeRightRail?n.createElement("div",{className:"comments-blade-disabled-wrapper"},n.createElement(f.Text,{size:"small",color:"faint"},S.formatMessage(C))):n.createElement("div",{className:_},y.showApproval&&x(["request"],!1),n.createElement(a.CommentStream,{actionsAdapter:B,enabled:!0,id:r,mentionsMatches:m||{},isMobile:!1,localization:k,settings:o.__assign(o.__assign({},U),{canShowEditorMeatball:this.props.config.showCommentsMeatball}),showRevisionInfo:!1,threads:N,activeThreadID:i,user:P,hoverThreadID:p,focusedThreadID:l,editorComponent:M,commentComponent:E,thirdPartySource:v,showUnreadPill:!0,placeholderOverride:q,useDesignV2:y.isInBladeRightRail,showResolvedComments:F,meatballMenu:this.getMeatballMenu(),renderApprovalForm:function(e){return x(e,!0)},approvalFormStatus:R,showApproval:y.showApproval}))},t})(n.PureComponent);t.TestOnlyCommentsPane=S,S.displayName="UnconnectedCommentsPane";var _=i.connect((function(e,t){var o,n,s,a,i=t.fileId,r=t.commentsBladeId,c=t.sharedLinkInfo,d=(null==c?void 0:c.url)||i;return{activeThreadID:e.activeThreadID[r],boltInfo:e.boltInfo.fileIdentifierToBoltMap[d],draftNumberedAnnotation:e.draftAnnotation[r],editorFocusRequested:Boolean(e.editorFocusRequest[r]),focusedThreadID:e.focusedThreadID[r],hoverThreadID:e.hoverThreadID[r],supportedEnhancements:e.supportedEnhancements[d],threads:e.threads[d],thirdPartySource:e.thirdPartySource[r],mentionsMatches:(o={},o[e.mentionsSearchResult.currentQuery]=e.mentionsSearchResult.result,o),status:e.status[d],framePreciseCommentsEnabled:null!==(s=null===(n=e.mediaAddonFeatures)||void 0===n?void 0:n.frame_precise_comments)&&void 0!==s&&s,showResolvedComments:e.showResolvedComments,approvalFormStatus:e.approvalFormStatus[d],canEnableCommenting:null===(a=e.permissions[d])||void 0===a?void 0:a.can_enable_commenting,commentsEnabled:v.areCommentsEnabled(e,d)}}))(S);t.CommentsBladePane=_}));
//# sourceMappingURL=pane.amd.min.js-vflFgFTt5.map